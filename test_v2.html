<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã V2</title>
    <script src="https://api.bitrix24.com/api/v1/"></script>
</head>
<body>
    <h1>–¢–µ—Å—Ç –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã V2</h1>
    <div id="log"></div>

    <script src="components/EntityManagerV2.js"></script>
    <script src="components/TaskHandler.js"></script>

    <script>
        const log = (msg, color = '#000') => {
            const div = document.createElement('div');
            div.style.color = color;
            div.textContent = msg;
            document.getElementById('log').appendChild(div);
            console.log(msg);
        };

        BX24.init(async () => {
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã...', '#0066cc');

            const testProcessId = 999; // –¢–µ—Å—Ç–æ–≤—ã–π ID –ø—Ä–æ—Ü–µ—Å—Å–∞

            try {
                // 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —É–∑–µ–ª –∑–∞–¥–∞—á–∏
                log('\nüìù –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —É–∑–ª–∞ –∑–∞–¥–∞—á–∏...', '#009688');
                const taskNode = {
                    nodeId: 'task-999',
                    type: 'task',
                    title: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
                    status: 2,
                    positionX: 100,
                    positionY: 100,
                    connectionsFrom: [],
                    connectionsTo: [],
                    condition: null,
                    realTaskId: 999
                };
                await EntityManagerV2.saveNode(testProcessId, taskNode);
                log('‚úÖ –£–∑–µ–ª –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–Ω', '#4caf50');

                // 2. –°–æ–∑–¥–∞—Ç—å 2 –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏
                log('\nüìù –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–∑–∞–¥–∞—á...', '#009688');
                const future1 = {
                    nodeId: 'future-1001',
                    type: 'future',
                    title: '–ü—Ä–µ–¥–∑–∞–¥–∞—á–∞ 1',
                    status: null,
                    positionX: 300,
                    positionY: 50,
                    connectionsFrom: [],
                    connectionsTo: [{ type: 'task', id: 'task-999' }],
                    condition: 'immediately',
                    realTaskId: null
                };
                await EntityManagerV2.saveNode(testProcessId, future1);
                log('‚úÖ –ü—Ä–µ–¥–∑–∞–¥–∞—á–∞ 1 —Å–æ–∑–¥–∞–Ω–∞', '#4caf50');

                const future2 = {
                    nodeId: 'future-1002',
                    type: 'future',
                    title: '–ü—Ä–µ–¥–∑–∞–¥–∞—á–∞ 2',
                    status: null,
                    positionX: 300,
                    positionY: 150,
                    connectionsFrom: [],
                    connectionsTo: [{ type: 'task', id: 'task-999' }],
                    condition: 'immediately',
                    realTaskId: null
                };
                await EntityManagerV2.saveNode(testProcessId, future2);
                log('‚úÖ –ü—Ä–µ–¥–∑–∞–¥–∞—á–∞ 2 —Å–æ–∑–¥–∞–Ω–∞', '#4caf50');

                // 3. –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑–∏ –∫ –∑–∞–¥–∞—á–µ
                log('\nüìù –®–∞–≥ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π...', '#009688');
                taskNode.connectionsFrom = [
                    { type: 'future', id: 'future-1001' },
                    { type: 'future', id: 'future-1002' }
                ];
                await EntityManagerV2.saveNode(testProcessId, taskNode);
                log('‚úÖ –°–≤—è–∑–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', '#4caf50');

                // 4. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 1 –∑–∞–ø—Ä–æ—Å!)
                log('\nüìù –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞...', '#009688');
                const allNodes = await EntityManagerV2.loadProcess(testProcessId);
                log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —É–∑–ª–æ–≤: ${allNodes.length}`, '#4caf50');
                allNodes.forEach(node => {
                    log(`  - ${node.nodeId}: ${node.title} (${node.type})`, '#666');
                });

                // 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑–∏
                log('\nüìù –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–µ–π...', '#009688');
                const task = allNodes.find(n => n.nodeId === 'task-999');
                log(`‚úÖ –°–≤—è–∑–µ–π –æ—Ç –∑–∞–¥–∞—á–∏: ${task.connectionsFrom.length}`, '#4caf50');
                task.connectionsFrom.forEach(conn => {
                    log(`  - ${conn.type}: ${conn.id}`, '#666');
                });

                // 6. –¢–µ—Å—Ç: —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å
                log('\nüìù –®–∞–≥ 6: –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å–≤—è–∑–∏...', '#009688');
                await EntityManagerV2.removeConnection(testProcessId, 'task-999', 'future-1002');
                const updated = await EntityManagerV2.loadProcess(testProcessId);
                const updatedTask = updated.find(n => n.nodeId === 'task-999');
                log(`‚úÖ –°–≤—è–∑–µ–π –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è: ${updatedTask.connectionsFrom.length}`, '#4caf50');

                // 7. –¢–µ—Å—Ç: –¥–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å –æ–±—Ä–∞—Ç–Ω–æ
                log('\nüìù –®–∞–≥ 7: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ –æ–±—Ä–∞—Ç–Ω–æ...', '#009688');
                await EntityManagerV2.addConnection(testProcessId, 'task-999', 'future', 'future-1002');
                const final = await EntityManagerV2.loadProcess(testProcessId);
                const finalTask = final.find(n => n.nodeId === 'task-999');
                log(`‚úÖ –°–≤—è–∑–µ–π –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${finalTask.connectionsFrom.length}`, '#4caf50');

                log('\n‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´!', '#4caf50');
                log('üéâ –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', '#4caf50');

            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, '#f44336');
                console.error(error);
            }
        });
    </script>
</body>
</html>
