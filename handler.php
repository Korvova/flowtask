<?php
// –í–∫–ª—é—á–∞–µ–º –ø—Ä–æ–ª–æ–≥ Bitrix
define("NO_KEEP_STATISTIC", true);
define("NO_AGENT_STATISTIC", true);
define("NOT_CHECK_PERMISSIONS", true);
define('PUBLIC_AJAX_MODE', true);

require($_SERVER["DOCUMENT_ROOT"] . "/bitrix/modules/main/include/prolog_before.php");

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è Push & Pull
if (!\Bitrix\Main\Loader::includeModule('pull')) {
    die('{"status":"error", "message":"–ú–æ–¥—É–ª—å Push & Pull –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."}');
}

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã Pull
\Bitrix\Main\UI\Extension::load('pull.client');
CJSCore::Init();
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Ü–µ—Å—Å—ã - Flowtask</title>
    <?php $APPLICATION->ShowHead(); ?>
    <script src="//api.bitrix24.com/api/v1/"></script>

    <script src="assets/js/react.min.js"></script>
    <script src="assets/js/react-dom.min.js"></script>
    <script src="assets/js/reactflow.min.js"></script>
    <link rel="stylesheet" href="assets/css/reactflow.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div id="root">
        <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script src="components/StatusColors.js?v=<?= time() ?>"></script>
    <script src="components/PullSubscription.js?v=<?= time() ?>"></script>
    <script src="components/TaskCreator.js?v=<?= time() ?>"></script>
    <script src="components/TaskNode.js?v=<?= time() ?>"></script>
    <script src="components/TaskModal.js?v=<?= time() ?>"></script>
    <script src="components/FlowCanvas.js?v=<?= time() ?>"></script>

    <script>
        function showInstallPage() {
            document.getElementById("root").innerHTML = `
                <div style="max-width: 800px; margin: 50px auto; padding: 40px; background: white; border-radius: 15px;">
                    <h1>üöÄ Flowtask</h1>
                    <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –û—Ç–∫—Ä–æ–π—Ç–µ –ª—é–±—É—é –∑–∞–¥–∞—á—É –∏ –Ω–∞–π–¥–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É "–ü—Ä–æ—Ü–µ—Å—Å—ã".</p>
                </div>
            `;
            BX24.fitWindow();
        }

        BX24.init(function() {
            console.log('üöÄ Flowtask');

            const placement = BX24.placement.info();

            if (placement?.placement === "DEFAULT") {
                showInstallPage();
                return;
            }

            const taskId = placement?.options?.taskId || placement?.options?.ID;

            if (!taskId) {
                document.getElementById("root").innerHTML =
                    "<div class=\"loading\">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞—á–∏</div>";
                return;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º BX.PULL –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if (typeof BX !== 'undefined' && typeof BX.PULL !== 'undefined') {
                BX.PULL.start();
                console.log('‚úÖ Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã');
            }

            BX24.callMethod("tasks.task.get", { taskId: taskId }, function(result) {
                if (result.error()) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏:', result.error());
                    document.getElementById("root").innerHTML =
                        "<div class=\"loading\">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏</div>";
                    return;
                }

                const task = result.data().task;
                console.log('‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', task.id, task.title);

                if (typeof window.FlowCanvas !== "undefined") {
                    window.FlowCanvas.render(task);
                } else {
                    console.error("FlowCanvas not loaded");
                }
            });

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É iframe
            setTimeout(() => {
                BX24.resizeWindow(window.innerWidth, Math.max(window.innerHeight, 1200));
            }, 500);
        });
    </script>
</body>
</html>
