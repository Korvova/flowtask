# Инструкция по установке FlowTask

## Требования

- Bitrix24 (облачная или коробочная версия)
- Node.js 18+ (для разработки)
- Доступ к Bitrix24 Маркету или локальная установка

---

## Шаг 1: Регистрация приложения в Bitrix24

### Для разработчиков (локальная разработка):

1. Перейти в **Настройки → Разработчикам → Другое → Локальные приложения**
2. Нажать **Добавить приложение**
3. Заполнить форму:
   - **Код:** `flowtask`
   - **Название:** `FlowTask - Визуальное управление процессами`
   - **Путь:** `https://your-domain.com/flowtask/` (ваш адрес)
   - **Права доступа (scope):**
     - `task` - работа с задачами
     - `entity` - работа с хранилищем данных
     - `user` - получение информации о пользователях
     - `sonet` - работа с группами
     - `placement` - встраивание виджетов

4. Сохранить и получить **CLIENT_ID** и **CLIENT_SECRET**

### Для публикации в Маркет:

1. Перейти на https://www.bitrix24.ru/apps/
2. Зарегистрироваться как разработчик
3. Создать новое приложение через форму
4. Загрузить файлы приложения
5. Пройти модерацию

---

## Шаг 2: Установка приложения на портал

### Автоматическая установка (при первом запуске):

**Файл:** `install/index.php`

```php
<?php
// Обработчик установки приложения
if ($_REQUEST['event'] === 'ONAPPINSTALL') {
    // 1. Создать Entity Storage
    $result = CRest::call('entity.add', [
        'ENTITY' => 'tflow_nodes',
        'NAME' => 'FlowTask - All Nodes',
        'ACCESS' => ['AU' => 'W']
    ]);

    // 2. Зарегистрировать placement
    CRest::call('placement.bind', [
        'PLACEMENT' => 'TASK_VIEW_TAB',
        'HANDLER' => 'https://your-domain.com/flowtask/index.html',
        'TITLE' => 'Процессы',
        'DESCRIPTION' => 'Визуальное управление процессами задач'
    ]);

    // 3. Подписаться на события
    CRest::call('event.bind', [
        'event' => 'ONTASKUPDATE',
        'handler' => 'https://your-domain.com/flowtask/webhook/task-update'
    ]);

    CRest::call('event.bind', [
        'event' => 'ONTASKCOMPLETE',
        'handler' => 'https://your-domain.com/flowtask/webhook/task-complete'
    ]);

    CRest::call('event.bind', [
        'event' => 'ONTASKDELETE',
        'handler' => 'https://your-domain.com/flowtask/webhook/task-delete'
    ]);

    // 4. Сохранить дату установки
    CRest::call('app.option.set', [
        'options' => [
            'install_date' => date('Y-m-d'),
            'subscription_status' => 'trial',
            'subscription_expires' => date('Y-m-d', strtotime('+30 days')),
            'version' => '1.0.0'
        ]
    ]);

    echo json_encode(['success' => true]);
}
?>
```

### Проверка установки:

После установки проверить в Bitrix24:

1. Открыть любую задачу
2. Должна появиться вкладка **"Процессы"**
3. При клике открывается полотно FlowTask

---

## Шаг 3: Разработка и сборка фронтенда

### Установка зависимостей:

```bash
cd flowtask
npm install
```

**package.json:**
```json
{
  "name": "flowtask",
  "version": "1.0.0",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "reactflow": "^11.10.0",
    "@bitrix24/b24jssdk": "^1.0.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "@vitejs/plugin-react": "^4.2.0"
  }
}
```

### Разработка:

```bash
npm run dev
# Откроется http://localhost:5173
```

### Сборка для продакшена:

```bash
npm run build
# Файлы появятся в dist/
```

### Деплой:

```bash
# Скопировать dist/ на ваш сервер
scp -r dist/* user@your-domain.com:/var/www/flowtask/
```

---

## Шаг 4: Настройка webhook'ов

### Создать endpoint для обработки событий:

**Файл:** `server/webhook-handler.js`

```javascript
const express = require('express');
const app = express();

app.use(express.json());

// Обработка обновления задачи
app.post('/webhook/task-update', async (req, res) => {
  const { data, event } = req.body;

  console.log('Task updated:', data);

  // Проверить изменение статуса
  if (data.FIELDS_BEFORE.STATUS !== data.FIELDS_AFTER.STATUS) {
    const taskId = data.FIELDS_AFTER.ID;
    const newStatus = data.FIELDS_AFTER.STATUS;

    // Проверить условия и создать связанные задачи
    await checkConditionsAndCreateTasks(taskId, newStatus);
  }

  res.json({ success: true });
});

// Запуск сервера
app.listen(3000, () => {
  console.log('Webhook handler running on port 3000');
});
```

### Настроить nginx для проксирования:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location /flowtask/ {
        root /var/www;
        try_files $uri $uri/ /flowtask/index.html;
    }

    location /flowtask/webhook/ {
        proxy_pass http://localhost:3000/webhook/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## Шаг 5: Первый запуск

### Открыть приложение:

1. Перейти в Bitrix24
2. Открыть любую задачу
3. Кликнуть на вкладку **"Процессы"**
4. При первом открытии появится **ProcessSelector**
5. Выбрать "Создать новый процесс"
6. Ввести название процесса или использовать ID задачи
7. Нажать "Применить"

### Проверить работу:

1. На полотне должна появиться карточка задачи
2. Кликнуть на точку на грани карточки
3. Перетащить линию и отпустить
4. Должна открыться форма создания предзадачи
5. Заполнить и сохранить
6. На полотне появится темно-серая карточка предзадачи

---

## Шаг 6: Проверка подписки

### Тестирование триального периода:

```javascript
// В консоли браузера
BX24.callMethod('app.option.get', {}, function(result) {
    console.log('Subscription:', result.data());
});

// Должно вернуть:
{
    install_date: "2025-10-30",
    subscription_status: "trial",
    subscription_expires: "2025-11-30"
}
```

### Имитация истечения триала:

```javascript
BX24.callMethod('app.option.set', {
    options: {
        subscription_expires: "2025-10-01" // Прошедшая дата
    }
});

// Перезагрузить приложение - должно показать окно оплаты
```

---

## Troubleshooting

### Проблема: Вкладка "Процессы" не появляется

**Решение:**
1. Проверить регистрацию placement:
```javascript
BX24.callMethod('placement.list', {}, function(result) {
    console.log(result.data());
});
```

2. Переустановить приложение:
```javascript
BX24.callMethod('placement.unbind', {
    PLACEMENT: 'TASK_VIEW_TAB'
});

// Затем снова вызвать placement.bind
```

### Проблема: Не создается хранилище tflow_nodes

**Решение:**
1. Проверить права доступа (scope: entity)
2. Проверить существование:
```javascript
BX24.callMethod('entity.get', {
    ENTITY: 'tflow_nodes'
}, function(result) {
    if (result.error()) {
        console.error('Storage not found');
    }
});
```

3. Создать вручную через консоль

### Проблема: Pull & Push не работает

**Решение:**
1. Проверить загрузку модуля:
```javascript
console.log(typeof BX.PULL); // должно быть 'object'
```

2. Загрузить модуль явно:
```html
<script src="//api.bitrix24.com/api/v1/pull/"></script>
```

### Проблема: Webhook не получает события

**Решение:**
1. Проверить подписку на события:
```javascript
BX24.callMethod('event.get', {}, function(result) {
    console.log(result.data());
});
```

2. Проверить доступность webhook URL:
```bash
curl -X POST https://your-domain.com/flowtask/webhook/task-update \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

---

## Проверочный список после установки

- [ ] Вкладка "Процессы" появляется в задачах
- [ ] Хранилище `tflow_nodes` создано
- [ ] ProcessSelector показывается при первом открытии
- [ ] Можно создать и переместить карточку задачи
- [ ] Можно создать предзадачу с формой
- [ ] Цвет карточки меняется при изменении статуса
- [ ] Webhook получает события от Bitrix24
- [ ] Проверка подписки работает
- [ ] При истечении триала показывается окно оплаты

---

## Полезные ссылки

- [Документация Bitrix24 REST API](https://dev.1c-bitrix.ru/rest_help/)
- [React Flow Documentation](https://reactflow.dev/)
- [Bitrix24 JS SDK](https://github.com/bitrix24/b24jssdk)
- [Entity Storage API](https://dev.1c-bitrix.ru/rest_help/entity/)

---

**Версия:** 1.0
**Последнее обновление:** 2025-10-30
