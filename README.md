# Flowtask - –í–∏–∑—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è Bitrix24

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –≤ Bitrix24.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
flowtask/
‚îú‚îÄ‚îÄ handler.php              # –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ install.php              # –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ components/              # JavaScript –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ EntityManager.js     # üÜï –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Entity Storage
‚îÇ   ‚îú‚îÄ‚îÄ FlowCanvas.js        # –ì–ª–∞–≤–Ω—ã–π canvas –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ TaskCreator.js       # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏–∑ –ø—Ä–µ–¥–∑–∞–¥–∞—á
‚îÇ   ‚îú‚îÄ‚îÄ TaskNode.js          # –£–∑–µ–ª –∑–∞–¥–∞—á–∏ –Ω–∞ canvas
‚îÇ   ‚îú‚îÄ‚îÄ TaskModal.js         # –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏
‚îÇ   ‚îú‚îÄ‚îÄ PullSubscription.js  # Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ StatusColors.js      # –¶–≤–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–¥–∞—á
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.css         # –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ reactflow.css    # –°—Ç–∏–ª–∏ React Flow
‚îÇ   ‚îî‚îÄ‚îÄ js/                  # React –∏ React Flow –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
‚îú‚îÄ‚îÄ api/                     # PHP API endpoints
‚îî‚îÄ‚îÄ task_*_webhook.php       # Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
```

## üóÑÔ∏è Entity Storage

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 4 —Ç–∏–ø–∞ Entity –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

### 1. **tflow_pos** - –ü–æ–∑–∏—Ü–∏–∏ —É–∑–ª–æ–≤
```json
{
  "nodeId": "task-123",
  "positionX": 250,
  "positionY": 100,
  "processId": "111"
}
```

### 2. **tflow_future** - –ü—Ä–µ–¥–∑–∞–¥–∞—á–∏
```json
{
  "futureId": "future-1761665000000",
  "parentTaskId": 111,
  "processId": "111",
  "title": "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞",
  "description": "–û–ø–∏—Å–∞–Ω–∏–µ",
  "responsibleId": 1,
  "groupId": 0,
  "conditionType": "ifComplete_create",
  "delayMinutes": 0,
  "positionX": 500,
  "positionY": 200,
  "isCreated": false,
  "realTaskId": null
}
```

### 3. **tflow_conn** - –°–≤—è–∑–∏
```json
{
  "parentTaskId": 111,
  "processId": "111",
  "sourceId": "task-111",
  "targetId": "future-1761665000000",
  "connectionType": "future"
}
```

### 4. **tflow_tmpl** - –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
```json
{
  "templateName": "–®–∞–±–ª–æ–Ω –ø—Ä–æ—Ü–µ—Å—Å–∞",
  "templateData": "{...}",
  "createdBy": 1,
  "createdAt": 1761665000
}
```

## üîß EntityManager API

### –ü–æ–∑–∏—Ü–∏–∏
```javascript
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
await EntityManager.savePosition('task-123', 250, 100, '111');

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é
const position = await EntityManager.loadPosition('task-123');
// => { x: 250, y: 100 }
```

### –ü—Ä–µ–¥–∑–∞–¥–∞—á–∏
```javascript
// –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–∑–∞–¥–∞—á—É
await EntityManager.createFutureTask({
  futureId: 'future-123',
  title: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
  processId: '111',
  // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
});

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
const futureTasks = await EntityManager.loadFutureTasks('111');

// –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–∑–∞–¥–∞—á—É
await EntityManager.updateFutureTask(entityId, futureData);

// –£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–∑–∞–¥–∞—á—É
await EntityManager.deleteFutureTask(entityId);
```

### –°–≤—è–∑–∏
```javascript
// –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å
await EntityManager.createConnection({
  sourceId: 'task-111',
  targetId: 'future-123',
  processId: '111',
  connectionType: 'future'
});

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤—è–∑–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
const connections = await EntityManager.loadConnections('111');

// –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å
await EntityManager.updateConnection(entityId, connectionData);

// –£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å
await EntityManager.deleteConnection(entityId);

// –ó–∞–º–µ–Ω–∏—Ç—å futureId –Ω–∞ taskId –≤–æ –≤—Å–µ—Ö —Å–≤—è–∑—è—Ö
await EntityManager.replaceFutureWithTask('future-123', '456');
```

### –ú–∏–≥—Ä–∞—Ü–∏—è
```javascript
// –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–≤—è–∑–∏ –±–µ–∑ processId
const migratedCount = await EntityManager.migrateOldConnections('111', '111');
```

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ProcessId

**ProcessId** - —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∑–∞–¥–∞—á –∏ –¥–∞–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

### –ü—Ä–∞–≤–∏–ª–∞:
1. **–ö–æ—Ä–Ω–µ–≤–∞—è –∑–∞–¥–∞—á–∞** –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–ª—É—á–∞–µ—Ç `processId = task.id`
2. **–í—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –∑–∞–¥–∞—á–∏** –Ω–∞—Å–ª–µ–¥—É—é—Ç `processId` –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è
3. **–í—Å–µ –¥–∞–Ω–Ω—ã–µ** (–ø–æ–∑–∏—Ü–∏–∏, –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏, —Å–≤—è–∑–∏) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å `processId`
4. **–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ** –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ `processId`

### –ü—Ä–∏–º–µ—Ä:
```
–ó–∞–¥–∞—á–∞-111 (–∫–æ—Ä–Ω–µ–≤–∞—è)
  processId = "111"
  ‚Üì —Å–æ–∑–¥–∞–µ—Ç
–ó–∞–¥–∞—á–∞-112
  processId = "111" (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è!)
  ‚Üì —Å–æ–∑–¥–∞–µ—Ç
–ó–∞–¥–∞—á–∞-113
  processId = "111" (–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è!)
```

–í—Å–µ —Å–≤—è–∑–∏, –ø–æ–∑–∏—Ü–∏–∏ –∏ –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏ –∏–º–µ—é—Ç `processId = "111"`, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –∑–∞–¥–∞—á –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–∞.

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –û—Ç–∫—Ä—ã—Ç—å `install.php` –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ù–∞–∂–∞—Ç—å "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Å—Ç:
   - 4 Entity (tflow_pos, tflow_future, tflow_conn, tflow_tmpl)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø–æ–ª–µ `UF_FLOWTASK_PROCESS_ID`
   - Placement "–ü—Ä–æ—Ü–µ—Å—Å—ã" –≤–æ –≤–∫–ª–∞–¥–∫–∞—Ö –∑–∞–¥–∞—á–∏
   - Webhook –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## üì° Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Bitrix Push & Pull** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:

- `BX.PULL.start()` - –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
- `PullSubscription.subscribe()` - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –∑–∞–¥–∞—á–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏

## üé® –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### FlowCanvas
–ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ React + React Flow. –£–ø—Ä–∞–≤–ª—è–µ—Ç:
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —É–∑–ª–æ–≤ (–∑–∞–¥–∞—á–∏, –ø—Ä–µ–¥–∑–∞–¥–∞—á–∏)
- –°–æ–∑–¥–∞–Ω–∏–µ–º —Å–≤—è–∑–µ–π
- Drag & Drop —É–∑–ª–æ–≤
- –ú–æ–¥–∞–ª–∫–∞–º–∏

### TaskCreator
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∏–∑ –ø—Ä–µ–¥–∑–∞–¥–∞—á:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è (ifComplete, ifDelay, ifCancel)
- –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
- –ù–∞—Å–ª–µ–¥—É–µ—Ç processId
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤—è–∑–∏ –≤ Entity

### EntityManager
–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Entity Storage:
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏
- –ü—Ä–æ–º–∏—Å—ã –¥–ª—è async/await
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üêõ –û—Ç–ª–∞–¥–∫–∞

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç –≤ –∫–æ–Ω—Å–æ–ª—å:
- `üöÄ` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- `‚úÖ` - –£—Å–ø–µ—à–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
- `‚ùå` - –û—à–∏–±–∫–∞
- `‚ö†Ô∏è` - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- `üì•` - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- `üíæ` - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- `üîÑ` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–º–∏–≥—Ä–∞—Ü–∏—è

## üìù TODO

- [ ] –®–∞–±–ª–æ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞)
- [ ] –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ JSON
- [ ] –ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ JSON
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–∞
