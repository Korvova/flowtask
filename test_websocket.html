<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç WebSocket PULL</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .event { padding: 5px; margin: 5px 0; background: #e3f2fd; border-left: 4px solid #2196f3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå –¢–µ—Å—Ç WebSocket PULL</h1>
        <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button onclick="sendTestEvent()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</button>
        <div id="status">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
        <div class="log" id="log"></div>
    </div>

    <script>
        let ws = null;
        const userId = 1; // ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        function log(msg, isEvent = false) {
            const logDiv = document.getElementById('log');
            const div = document.createElement('div');
            div.className = isEvent ? 'event' : '';
            div.textContent = new Date().toLocaleTimeString() + ' | ' + msg;
            logDiv.insertBefore(div, logDiv.firstChild);
        }

        function connect() {
            if (ws) {
                log('–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return;
            }

            ws = new WebSocket('ws://localhost:8893');

            ws.onopen = () => {
                log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                document.getElementById('status').textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω';
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
                ws.send(JSON.stringify({
                    command: 'subscribe',
                    userId: userId
                }));
                log('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ' + userId);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('üì¨ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ' + JSON.stringify(data), true);
                
                if (data.command === 'task_status_changed') {
                    log('üîî –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ ' + data.params.TASK_ID + ' –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ' + data.params.STATUS, true);
                }
            };

            ws.onclose = () => {
                log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                document.getElementById('status').textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω';
                ws = null;
            };

            ws.onerror = (error) => {
                log('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function sendTestEvent() {
            fetch('http://localhost:8893/publish', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: userId,
                    event: {
                        module_id: 'telegsarflow',
                        command: 'task_status_changed',
                        params: {
                            TASK_ID: 3,
                            STATUS: 5,
                            test: true
                        }
                    }
                })
            })
            .then(r => r.json())
            .then(data => log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'))
            .catch(err => log('‚ùå –û—à–∏–±–∫–∞: ' + err.message));
        }

        // –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        window.addEventListener('load', connect);
    </script>
</body>
</html>
