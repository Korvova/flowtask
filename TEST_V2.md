# Тестирование новой архитектуры V2

## Что изменилось

### Старая архитектура (МЕДЛЕННО):
- 3 таблицы Entity: `tflow_conn`, `tflow_pos`, `tflow_future`
- 10+ API запросов для загрузки процесса (диапазоны 200-299, 300-399, и т.д.)
- Сложная рекурсивная логика в TaskCreator
- Проблемы с синхронизацией данных между таблицами

### Новая архитектура (БЫСТРО):
- **1 таблица**: `tflow_nodes`
- **1 API запрос** для загрузки всего процесса через `FILTER: { NAME: 'process_126' }`
- Простая линейная логика в TaskHandler
- Все данные в одном месте - нет проблем синхронизации

## Структура данных

Каждый узел (task или future) хранится как отдельная запись:

```javascript
{
  NAME: 'process_126',  // Для фильтрации по процессу
  DETAIL_TEXT: {
    nodeId: 'task-127',           // Уникальный ID узла
    type: 'task',                 // task / future
    title: 'Название задачи',
    status: 5,                    // Статус задачи (если task)
    positionX: 100,               // Координаты на canvas
    positionY: 200,
    connectionsFrom: [            // Связи ОТ этого узла
      { type: 'future', id: 'future-1001' },
      { type: 'future', id: 'future-1002' }
    ],
    connectionsTo: [              // Связи К этому узлу
      { type: 'task', id: 'task-126' }
    ],
    condition: 'immediately',     // Условие создания (для future)
    realTaskId: null              // ID реальной задачи (для future)
  }
}
```

## Компоненты V2

### 1. EntityManagerV2.js
**Простой менеджер данных**

```javascript
// Загрузить весь процесс (1 запрос!)
const nodes = await EntityManagerV2.loadProcess(processId);

// Сохранить узел
await EntityManagerV2.saveNode(processId, node);

// Добавить связь
await EntityManagerV2.addConnection(processId, sourceId, targetType, targetId);

// Удалить связь
await EntityManagerV2.removeConnection(processId, sourceId, targetId);

// Удалить узел
await EntityManagerV2.deleteNode(processId, nodeId);
```

### 2. TaskHandler.js
**Простой обработчик завершения задач (без рекурсии!)**

```javascript
await TaskHandler.handleTaskComplete(taskId, processId);
```

Логика:
1. Загружает все узлы (1 запрос)
2. Находит завершённую задачу
3. Берёт её `connectionsFrom` (массив предзадач)
4. Создаёт реальные задачи для каждой future
5. Обновляет future узлы с realTaskId

### 3. FlowCanvasV2.js
**Простой React Flow canvas**

- Загрузка: `EntityManagerV2.loadProcess()` → строим nodes/edges
- Создание связи: добавляем в массив `connectionsFrom`
- Завершение задачи: вызываем `TaskHandler.handleTaskComplete()`

### 4. TaskModalV2.js
**Простой модальный диалог**

- Запрашивает название предзадачи
- Создаёт future узел
- Добавляет связи

## Как тестировать

### Вариант 1: Тестовая страница

1. Откройте в браузере:
   ```
   https://ваш-домен/flowtask/test_v2.html
   ```

2. Откройте консоль разработчика (F12)

3. Проверьте логи - должно быть:
   - Создание узлов задачи и предзадач
   - Добавление связей
   - Загрузка процесса (1 запрос!)
   - Удаление и добавление связей

### Вариант 2: Реальная задача в Bitrix24

1. Создайте новую задачу в Bitrix24 (например, #130)

2. Откройте вкладку "Процессы"

3. В консоли должно появиться:
   ```
   ✅ Используем FlowCanvasV2 (новая архитектура)
   ```

4. Попробуйте:
   - Создать предзадачу (правый клик на задаче)
   - Переместить узлы (должны сохраняться сразу)
   - Завершить задачу - предзадачи должны создаться

5. Проверьте Network tab:
   - Должен быть ТОЛЬКО 1 запрос `entity.item.get` с фильтром
   - Старые запросы с диапазонами должны отсутствовать

## Сравнение производительности

| Действие | Старая архитектура | Новая V2 |
|----------|-------------------|----------|
| Загрузка процесса | 10+ запросов | 1 запрос |
| Создание связи | 1 запрос | 1 запрос |
| Обновление позиции | 1 запрос | 1 запрос |
| Завершение задачи | Рекурсия + 5-10 запросов | Простой цикл + 3-5 запросов |

**Результат: В 5-10 раз быстрее!**

## Миграция данных

Старые процессы (с NAME вида `task-123->future-456`) НЕ будут работать с новой архитектурой.

Для новых процессов используется новый формат NAME: `process_126`

Если нужно мигрировать старые данные, можно написать скрипт миграции.

## Откат на старую версию

Если что-то сломается, в handler.php есть fallback:

```javascript
if (typeof window.FlowCanvasV2 !== "undefined") {
    // Используем V2
} else if (typeof window.FlowCanvas !== "undefined") {
    // Откат на старую версию
}
```

Просто закомментируйте строки подключения V2 компонентов.

## Проверка что используется V2

Откройте консоль браузера и проверьте:

```javascript
// Должно быть true
console.log(typeof window.EntityManagerV2 !== 'undefined');
console.log(typeof window.FlowCanvasV2 !== 'undefined');
console.log(typeof window.TaskHandler !== 'undefined');
```

В логах должно быть:
```
✅ Используем FlowCanvasV2 (новая архитектура)
```

## Что дальше?

После успешного тестирования:

1. Удалить старые компоненты (EntityManager.js, TaskCreator.js, FlowCanvas.js)
2. Переименовать V2 компоненты (убрать V2 из названий)
3. Написать миграцию для старых данных (опционально)
